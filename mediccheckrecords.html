<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medic 75 Logs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, query, orderBy, onSnapshot, limit } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBsaM_8RjTsgaSOPrOkyaK1DXghCHumxkc",
            authDomain: "pleasant-fire.firebaseapp.com",
            projectId: "pleasant-fire",
            storageBucket: "pleasant-fire.firebasestorage.app",
            messagingSenderId: "107375626982",
            appId: "1:107375626982:web:97eed5f81377b15eba8927",
            measurementId: "G-TT4G7K37M2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        // Updated default appId to match new project ID
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'pleasant-fire';

        let allLogs = [];

        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } catch (e) {
                         console.warn("Custom token mismatch, falling back to anonymous auth", e);
                         await signInAnonymously(auth);
                    }
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Error", error);
                alert("Authentication failed. Please refresh.");
            }
        }

        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                loadLogs();
            }
        });
        
        // Helper to format dates MM/DD/YYYY
        function formatDate(val) {
            if (!val) return 'N/A';

            // Fix for timezone issue: manually parse YYYY-MM-DD strings
            // creating new Date('YYYY-MM-DD') creates a UTC date which shifts to previous day in Western timezones
            if (typeof val === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(val)) {
                const [y, m, d] = val.split('-');
                return `${m}/${d}/${y}`;
            }

            const date = new Date(val);
            if (isNaN(date.getTime())) return val; // Return original if not a valid date
            
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            const yyyy = date.getFullYear();
            return `${mm}/${dd}/${yyyy}`;
        }
        
        // Helper to format date + time
        function formatDateTime(val) {
             if (!val) return 'N/A';
             const date = new Date(val);
             if (isNaN(date.getTime())) return val;
             return date.toLocaleString('en-US'); // MM/DD/YYYY, H:MM:SS AM/PM
        }

        function loadLogs() {
            // Using the preview artifact path as per rules
            const q = query(
                collection(db, 'artifacts', appId, 'public', 'data', 'medic_75_daily_checks'),
                orderBy('submittedAt', 'desc'),
                limit(50)
            );

            onSnapshot(q, (snapshot) => {
                const logsList = document.getElementById('logsList');
                logsList.innerHTML = '';
                allLogs = [];

                snapshot.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    allLogs.push(data);
                    
                    // Safe accessors
                    const submittedBy = data.sections?.General?.SubmittedBy || data.General_SubmittedBy || 'Unknown';
                    const rawDate = data.sections?.General?.Date || data.General_Date;
                    const displayDate = formatDate(rawDate);
                    
                    const mileage = data.sections?.Cab?.Mileage || data.Cab_Mileage || 'N/A';
                    const comments = data.sections?.General?.Comments || data.General_Comments || '';
                    const submittedAt = formatDateTime(data.submittedAt);

                    const row = document.createElement('tr');
                    row.className = "hover:bg-gray-50 cursor-pointer border-b";
                    row.onclick = () => showDetails(data.id);
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${submittedAt}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${submittedBy}</td>
                         <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${displayDate}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${mileage}</td>
                        <td class="px-6 py-4 text-sm text-gray-500 truncate max-w-xs">${comments}</td>
                    `;
                    logsList.appendChild(row);
                });
            }, (error) => {
                console.error("Error fetching logs:", error);
                document.getElementById('logsList').innerHTML = '<tr><td colspan="5" class="text-center p-4 text-red-500">Error loading logs. Permission denied or collection empty.</td></tr>';
            });
        }

        window.showDetails = (id) => {
            const log = allLogs.find(l => l.id === id);
            if (!log) return;

            const content = document.getElementById('modalContent');
            let mainHtml = '';
            let footerHtml = '';

            // Handle both flat structure and sectioned structure
            const sections = log.sections || {};
            
            // Helper to print object
            const printObj = (obj, title) => {
                if(!obj || Object.keys(obj).length === 0) return '';
                
                // Identify if this is likely the signature section for layout adjustment
                // Also check if any value in the object looks like an image to treat this section as an image container
                const hasImages = Object.values(obj).some(v => typeof v === 'string' && (v.startsWith('data:image') || v.startsWith('http')));
                const isSigSection = title.toLowerCase().includes('signature') || title.toLowerCase().includes('footer') || hasImages;

                let h = `<div class="mb-4 ${isSigSection ? 'mt-6 pt-4 border-t border-gray-200' : ''}">
                            <h3 class="font-bold text-blue-800 border-b mb-2">${title}</h3>
                            <div class="${isSigSection ? 'flex flex-wrap gap-8' : 'grid grid-cols-2 gap-2'} text-sm">`;
                
                for(const [k, v] of Object.entries(obj)) {
                    // beautify key
                    let niceKey = k.replace(/([A-Z])/g, ' $1').trim();
                    let niceVal = v;
                    
                    const isImageString = typeof v === 'string' && (v.startsWith('data:image') || v.startsWith('http'));

                    // Checkbox Logic
                    if (v === true) {
                        niceVal = '<span class="text-green-600 font-bold">✓ Yes</span>';
                    } else if (v === false) {
                         niceVal = '<span class="text-red-500 font-bold">✗ No</span>';
                    } else if (typeof v === 'string') {
                        if (isImageString) {
                            // Render as image
                            niceVal = `<img src="${v}" alt="${niceKey}" class="mt-2 h-24 border border-gray-300 rounded bg-white shadow-sm block max-w-full">`;
                        } else if (v.match(/^\d{4}-\d{2}-\d{2}$/)) {
                            // Date Logic (YYYY-MM-DD -> MM/DD/YYYY)
                            niceVal = formatDate(v);
                        }
                    }
                    
                    // Render logic
                    if (isImageString) {
                        // Full width/block for signatures/images
                        h += `<div class="flex flex-col mb-2 min-w-[200px]"><span class="font-semibold text-gray-600 mb-1">${niceKey}</span> ${niceVal}</div>`;
                    } else {
                        h += `<div><span class="font-semibold text-gray-600">${niceKey}:</span> ${niceVal}</div>`;
                    }
                }
                h += `</div></div>`;
                return h;
            };

            // If flat structure (legacy or fallback), group manually (simplified)
            if(Object.keys(sections).length === 0 && Object.keys(log).length > 3) {
                 mainHtml += printObj(log, "Full Log Data");
            } else {
                // Sort entries so 'General' comes first
                const sortedEntries = Object.entries(sections).sort((a, b) => {
                    const keyA = a[0];
                    const keyB = b[0];
                    if (keyA === 'General') return -1;
                    if (keyB === 'General') return 1;
                    return 0;
                });

                // Dynamically iterate over all sections to ensure no fields are hidden
                for (const [key, val] of sortedEntries) {
                    // Only process objects (sections)
                    if (val && typeof val === 'object') {
                        // Create a readable title (e.g., "FirstIn" -> "First In")
                        const title = key.replace(/([A-Z])/g, ' $1').trim();
                        
                        // Check if this is the Signatures section (loosened check to catch various namings)
                        if (key.toLowerCase().includes('signature') || key.toLowerCase().includes('footer')) {
                            footerHtml += printObj(val, title);
                        } else {
                            mainHtml += printObj(val, title);
                        }
                    }
                }
            }

            // Append footerHtml at the end
            content.innerHTML = mainHtml + footerHtml;
            document.getElementById('detailModal').classList.remove('hidden');
        };

        window.closeModal = () => {
            document.getElementById('detailModal').classList.add('hidden');
        };
    </script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans h-screen flex flex-col">

    <header class="bg-blue-900 text-white p-4 shadow flex justify-between items-center">
        <h1 class="text-xl font-bold">Medic 75 Logs</h1>
        <a href="index.html" class="bg-blue-700 hover:bg-blue-600 px-4 py-2 rounded text-sm transition">New Checklist</a>
    </header>

    <div class="flex-1 overflow-auto p-4">
        <div class="bg-white rounded shadow overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Submitted By</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Shift Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mileage</th>
                         <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Comments</th>
                    </tr>
                </thead>
                <tbody id="logsList" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="5" class="text-center p-4 text-gray-500">Loading records...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal -->
    <div id="detailModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                <h2 class="text-lg font-bold text-gray-800">Checklist Details</h2>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="modalContent" class="p-6 overflow-y-auto">
                <!-- Content injected here -->
            </div>
            <div class="p-4 border-t bg-gray-50 rounded-b-lg text-right">
                <button onclick="closeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded">Close</button>
            </div>
        </div>
    </div>

</body>
</html>