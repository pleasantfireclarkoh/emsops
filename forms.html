<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1">
    <title>EMS OPS FORMS</title>
    <link rel="apple-touch-icon" sizes="180x180" href="https://i.ibb.co/DPD6PyGC/New-EMS-OPS-Logo.png">
    <link rel="icon" type="image/png" href="https://i.ibb.co/DPD6PyGC/New-EMS-OPS-Logo.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="EMS FORMS">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/lucide@latest"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .view-section { display: none; animation: fadeIn 0.3s ease-in-out; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .btn-choice.active { background-color: #eff6ff; border-color: #2563eb; color: #1e40af; }
        input[type="date"], input[type="datetime-local"] { width: 90%; max-width: 100%; box-sizing: border-box; }
        /* Modal Animation */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 0.2s, transform 0.2s; }
    </style>
</head>
<body class="text-gray-900 min-h-screen flex flex-col">

    <nav class="bg-slate-900 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3 cursor-pointer" onclick="app.navTo('hub')">
                    <img src="https://i.ibb.co/DPD6PyGC/New-EMS-OPS-Logo.png" alt="EMS Logo" class="w-12 h-12 rounded-lg shadow-sm">
                    <span class="font-bold text-lg tracking-wide">EMS OPS</span>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="app.navTo('hub')" id="nav-home-btn" class="hidden flex items-center justify-center gap-2 text-sm bg-slate-800 hover:bg-slate-700 px-4 py-2 rounded-md transition border border-slate-700 shadow-sm">
                        <i class="fa-solid fa-border-all"></i>
                        <span>Dashboard</span>
                    </button>
                    <div class="flex items-center gap-2 bg-slate-800 px-3 py-1.5 rounded-full border border-slate-700">
                        <div id="status-indicator" class="w-2 h-2 rounded-full bg-red-500"></div>
                        <span id="user-status" class="text-xs font-medium text-slate-300">Connecting...</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-grow max-w-6xl mx-auto w-full p-4 sm:p-6">
        
        <section id="view-hub" class="view-section active">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800">Operations Dashboard</h1>
                <p class="text-gray-500 mt-2">Select a module to begin</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div onclick="app.navTo('dailycheck')" class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 hover:shadow-md hover:border-indigo-300 cursor-pointer transition group relative overflow-hidden md:col-span-2 lg:col-span-1">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                        <i class="fa-solid fa-clipboard-check text-6xl text-indigo-600"></i>
                    </div>
                    <div class="flex items-center gap-4 mb-2 relative z-10">
                        <div class="w-12 h-12 rounded-full bg-indigo-100 flex items-center justify-center group-hover:bg-indigo-600 transition shadow-sm">
                            <i class="fa-solid fa-clipboard-check text-indigo-600 text-xl group-hover:text-white transition"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">Daily Medic Check</h3>
                            <p class="text-sm text-gray-500">Morning apparatus checklist</p>
                        </div>
                    </div>
                </div>

                <div onclick="app.navTo('supply')" class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 hover:shadow-md hover:border-blue-300 cursor-pointer transition group relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                        <i class="fa-solid fa-box-open text-6xl text-blue-600"></i>
                    </div>
                    <div class="flex items-center gap-4 mb-2 relative z-10">
                        <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center group-hover:bg-blue-600 transition shadow-sm">
                            <i class="fa-solid fa-box-open text-blue-600 text-xl group-hover:text-white transition"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">Supply Log</h3>
                            <p class="text-sm text-gray-500">Log out inventory items</p>
                        </div>
                    </div>
                </div>

                <div onclick="app.navTo('drugbag')" class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 hover:shadow-md hover:border-red-300 cursor-pointer transition group relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                        <i class="fa-solid fa-briefcase-medical text-6xl text-red-600"></i>
                    </div>
                    <div class="flex items-center gap-4 mb-2 relative z-10">
                        <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center group-hover:bg-red-600 transition shadow-sm">
                            <i class="fa-solid fa-briefcase-medical text-red-600 text-xl group-hover:text-white transition"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">Drug Bag Exchange</h3>
                            <p class="text-sm text-gray-500">Log bag swaps & expirations</p>
                        </div>
                    </div>
                </div>

                <div onclick="app.navTo('oxygen')" class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 hover:shadow-md hover:border-green-300 cursor-pointer transition group relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                        <i class="fa-solid fa-lungs text-6xl text-green-600"></i>
                    </div>
                    <div class="flex items-center gap-4 mb-2 relative z-10">
                        <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center group-hover:bg-green-600 transition shadow-sm">
                            <i class="fa-solid fa-lungs text-green-600 text-xl group-hover:text-white transition"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">Oxygen Log</h3>
                            <p class="text-sm text-gray-500">Main tanks & portables</p>
                        </div>
                    </div>
                </div>

                <div onclick="app.navTo('destroy')" class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 hover:shadow-md hover:border-purple-300 cursor-pointer transition group relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                        <i class="fa-solid fa-trash-can text-6xl text-purple-600"></i>
                    </div>
                    <div class="flex items-center gap-4 mb-2 relative z-10">
                        <div class="w-12 h-12 rounded-full bg-purple-100 flex items-center justify-center group-hover:bg-purple-600 transition shadow-sm">
                            <i class="fa-solid fa-trash-can text-purple-600 text-xl group-hover:text-white transition"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">Drug Destruction</h3>
                            <p class="text-sm text-gray-500">Log disposal of meds</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-supply" class="view-section">
            <div class="bg-white p-6 rounded-xl shadow-lg max-w-2xl mx-auto border-t-4 border-blue-600">
                <div class="border-b pb-4 mb-6 flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Log Out Supply</h2>
                        <p class="text-gray-500 text-sm">Inventory Management</p>
                    </div>
                    <button onclick="app.navTo('hub')" class="text-gray-400 hover:text-gray-600 bg-gray-100 p-2 rounded-full transition"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                
                <form id="supplyForm" class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Item Name</label>
                        <input list="supplyList" name="item" id="supplyItemInput" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-gray-50 focus:bg-white transition" placeholder="Search item...">
                        <datalist id="supplyList"></datalist>
                        <p id="supplyItemDetails" class="text-sm text-blue-600 mt-1 font-bold min-h-[1.25rem]"></p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Quantity Taken</label>
                        <input type="number" name="quantityTaken" id="supplyQtyInput" min="1" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-gray-50 focus:bg-white transition">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Member Name</label>
                        <select id="supplyMemberSelect" name="person" required class="member-select mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg bg-white focus:ring-blue-500">
                            <option value="" disabled selected>Loading members...</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Reason</label>
                        <div id="supplyReasonContainer" class="grid grid-cols-3 gap-2">
                            <button type="button" class="btn-choice border border-gray-300 py-3 rounded-lg font-medium text-gray-600 hover:bg-gray-50 transition" data-value="Use">Use</button>
                            <button type="button" class="btn-choice border border-gray-300 py-3 rounded-lg font-medium text-gray-600 hover:bg-gray-50 transition" data-value="Expiration">Expiration</button>
                            <button type="button" class="btn-choice border border-gray-300 py-3 rounded-lg font-medium text-gray-600 hover:bg-gray-50 transition" data-value="Training">Training</button>
                        </div>
                        <input type="hidden" id="supplyReasonInput" name="reason" required>
                    </div>

                    <button type="submit" id="supplySubmitBtn" class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-md transition flex justify-center items-center gap-2">
                        <span>Log Item</span>
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </section>

        <section id="view-drugbag" class="view-section">
            <div class="bg-white p-6 rounded-xl shadow-lg max-w-2xl mx-auto border-t-4 border-red-600">
                <div class="border-b pb-4 mb-6 flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Drug Bag Exchange</h2>
                        <p class="text-gray-500 text-sm">Bag Swap & Tracking</p>
                    </div>
                    <button onclick="app.navTo('hub')" class="text-gray-400 hover:text-gray-600 bg-gray-100 p-2 rounded-full transition"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>

                <form id="drugBagForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Apparatus</label>
                            <input type="text" value="Medic 75" readonly class="w-full mt-1 px-4 py-2 border bg-gray-100 rounded-lg text-gray-600 cursor-not-allowed">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Select Bag Slot</label>
                            <div class="grid grid-cols-2 gap-2">
                                <button type="button" id="btn-bag1" class="p-2 border rounded-lg text-center hover:bg-gray-50 transition" onclick="app.drugBag.selectBag('Bag 1')">
                                    <div id="label-bag1" class="text-lg font-bold">...</div>
                                    <div class="text-xs text-gray-500">Slot 1</div>
                                </button>
                                <button type="button" id="btn-bag2" class="p-2 border rounded-lg text-center hover:bg-gray-50 transition" onclick="app.drugBag.selectBag('Bag 2')">
                                    <div id="label-bag2" class="text-lg font-bold">...</div>
                                    <div class="text-xs text-gray-500">Slot 2</div>
                                </button>
                            </div>
                            <input type="hidden" id="drugBagIdentifier" value="Bag 1">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">New Bag Number</label>
                        <input type="number" id="drugNewBagNum" placeholder="e.g. 1234" class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 text-lg tracking-widest text-center font-mono">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">New Expiration</label>
                            <input type="date" id="drugExpiration" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Facility</label>
                            <select id="drugFacility" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                                <option value="" disabled selected>Select...</option>
                                <option value="Springfield Regional">Springfield Regional</option>
                                <option value="Kettering Health">Kettering Health</option>
                                <option value="Soin Medical">Soin Medical</option>
                                <option value="Miami Valley">Miami Valley</option>
                                <option value="Dayton Childrens">Dayton Children's</option>
                                <option value="Mercy - Urbana">Mercy - Urbana</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Reason</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button type="button" class="btn-reason border rounded-lg p-3 hover:bg-gray-50 font-medium text-sm transition" onclick="app.drugBag.selectReason('Used')">
                                Used <span id="display-run" class="block text-xs text-blue-600 font-bold mt-1"></span>
                            </button>
                            <button type="button" class="btn-reason border rounded-lg p-3 hover:bg-gray-50 font-medium text-sm transition" onclick="app.drugBag.selectReason('Expired')">
                                Expired <span id="display-expired" class="block text-xs text-blue-600 font-bold mt-1"></span>
                            </button>
                            <button type="button" class="btn-reason border rounded-lg p-3 hover:bg-gray-50 font-medium text-sm transition" onclick="app.drugBag.selectReason('Broken Seal')">Broken Seal</button>
                            <button type="button" class="btn-reason border rounded-lg p-3 hover:bg-gray-50 font-medium text-sm transition" onclick="app.drugBag.selectReason('Bag Update')">Bag Update</button>
                        </div>
                        <input type="hidden" id="drugReasonInput">
                        <input type="hidden" id="drugRunNumber">
                        <input type="hidden" id="drugOldExpiration">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Submitted By</label>
                        <select id="drugMemberSelect" required class="member-select mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg bg-white">
                            <option value="" disabled selected>Loading...</option>
                        </select>
                    </div>

                    <button type="submit" id="drugSubmitBtn" class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-md transition flex justify-center items-center gap-2">
                        <span>Submit Exchange</span>
                        <i class="fa-solid fa-check"></i>
                    </button>
                </form>
            </div>
        </section>

        <section id="view-oxygen" class="view-section">
            <div class="bg-white p-6 rounded-xl shadow-lg max-w-xl mx-auto border-t-4 border-green-600">
                <div class="mb-6 flex justify-between items-start">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 uppercase tracking-wide">Oxygen Log</h2>
                        <p class="text-gray-500 text-sm">Tank Checks & Exchanges</p>
                    </div>
                    <button onclick="app.navTo('hub')" class="text-gray-400 hover:text-gray-600 bg-gray-100 p-2 rounded-full transition"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>

                <form id="oxygenForm" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase">Reporting Member</label>
                        <select id="oxygenMemberSelect" required class="member-select mt-1 block w-full px-3 py-2 border border-gray-300 rounded bg-white">
                            <option value="" disabled selected>Loading...</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase">Log Type</label>
                        <select id="oxygenLogType" onchange="app.oxygen.toggleFields()" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded bg-gray-50">
                            <option value="Main Tank">Main Oxygen Tank Exchange</option>
                            <option value="Portable Bottle">Portable Bottle Check</option>
                        </select>
                    </div>

                    <div id="oxMainFields" class="bg-blue-50 p-4 rounded border-l-4 border-blue-500 space-y-3">
                        <h4 class="text-blue-800 font-bold text-sm flex items-center gap-2">
                            <i class="fa-solid fa-truck-medical"></i> MAIN TANK DETAILS
                        </h4>
                        <div class="grid grid-cols-2 gap-3">
                            <input type="text" id="oxNewLot" placeholder="New Lot #" class="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-blue-400">
                            <input type="text" id="oxOldLot" placeholder="Old Lot #" class="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-blue-400">
                            <input type="number" id="oxNewPsi" placeholder="New PSI" class="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-blue-400">
                            <input type="number" id="oxOldPsi" placeholder="Old PSI" class="w-full p-2 border rounded text-sm focus:ring-2 focus:ring-blue-400">
                        </div>
                    </div>

                    <div id="oxPortableFields" class="hidden bg-green-50 p-4 rounded border-l-4 border-green-500 space-y-3">
                        <h4 class="text-green-800 font-bold text-sm flex items-center gap-2">
                            <i class="fa-solid fa-suitcase-medical"></i> PORTABLE DETAILS
                        </h4>
                        <select id="oxPortableId" class="w-full p-2 border rounded bg-white mb-2">
                            <option value="" disabled selected>Select Location</option>
                            <option value="Jump Bag">Jump Bag</option>
                            <option value="Stretcher">Stretcher</option>
                            <option value="Spare 1">Spare 1</option>
                            <option value="Spare 2">Spare 2</option>
                        </select>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div class="col-span-2 font-bold text-gray-600 mt-1">Cylinder 1</div>
                            <input type="text" id="oxCyl1Lot" placeholder="Lot #" class="p-2 border rounded">
                            <input type="number" id="oxCyl1Psi" placeholder="PSI" class="p-2 border rounded">
                            <div class="col-span-2 font-bold text-gray-600 mt-2">Cylinder 2</div>
                            <input type="text" id="oxCyl2Lot" placeholder="Lot #" class="p-2 border rounded">
                            <input type="number" id="oxCyl2Psi" placeholder="PSI" class="p-2 border rounded">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase">Issues / Notes</label>
                        <textarea id="oxIssues" rows="2" class="mt-1 w-full p-2 border rounded" placeholder="Leaks, damages..."></textarea>
                    </div>

                    <button type="submit" id="oxSubmitBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded shadow transition flex justify-center items-center gap-2">
                        <span>Submit Log</span>
                        <i class="fa-solid fa-check"></i>
                    </button>
                </form>
            </div>
        </section>

        <section id="view-destroy" class="view-section">
            <div class="bg-white p-6 rounded-xl shadow-lg max-w-xl mx-auto border-t-4 border-purple-600">
                <div class="mb-6 flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <div class="bg-purple-100 p-2 rounded-lg">
                            <i data-lucide="trash-2" class="text-purple-600 w-6 h-6"></i>
                        </div>
                        <h2 class="text-xl font-bold text-gray-800">Destruction Record</h2>
                    </div>
                    <button onclick="app.navTo('hub')" class="text-gray-400 hover:text-gray-600 bg-gray-100 p-2 rounded-full transition"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>

                <form id="destroyForm" class="space-y-5">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Date</label>
                            <input type="date" id="destDate" required class="w-full mt-1 p-2 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Professional</label>
                            <input type="text" id="destProf" placeholder="Name" required class="w-full mt-1 p-2 border rounded-lg">
                        </div>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                        <h3 class="text-xs font-bold text-gray-500 uppercase mb-3">Drug Details</h3>
                        <div class="space-y-3">
                            <input type="text" id="destDrugName" placeholder="Drug Name" required class="w-full p-2 border rounded">
                            <div class="grid grid-cols-2 gap-3">
                                <input type="text" id="destStrength" placeholder="Strength (e.g. 4mg)" class="w-full p-2 border rounded">
                                <input type="text" id="destQty" placeholder="Qty (e.g. 2 vials)" required class="w-full p-2 border rounded">
                            </div>
                            <select id="destForm" class="w-full p-2 border rounded bg-white">
                                <option value="Injection (Vial)">Injection (Vial)</option>
                                <option value="Injection (Ampule)">Injection (Ampule)</option>
                                <option value="Tablet">Tablet</option>
                                <option value="Liquid">Liquid</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Disposal Method</label>
                        <select id="destMethod" class="w-full mt-1 p-2 border rounded-lg bg-white">
                            <option value="Chemical Digestion">Chemical Digestion</option>
                            <option value="Incineration">Incineration</option>
                            <option value="Reverse Distributor">Reverse Distributor</option>
                            <option value="Sewer">Sewer (If Permitted)</option>
                        </select>
                    </div>

                    <button type="submit" id="destSubmitBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 rounded shadow transition flex justify-center items-center gap-2">
                        <i data-lucide="save" class="w-4 h-4"></i> Sign & Save Record
                    </button>
                </form>
            </div>
        </section>

        <section id="view-dailycheck" class="view-section">
            <div class="max-w-4xl mx-auto">
                <div class="bg-blue-900 text-white p-6 rounded-t-xl shadow-lg flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold uppercase tracking-wider">Medic 75 Daily Check</h2>
                        <p class="text-blue-200 text-sm mt-1">Pleasant Township Fire Department</p>
                    </div>
                    <button onclick="app.navTo('hub')" class="text-blue-200 hover:text-white bg-blue-800 hover:bg-blue-700 p-2 rounded-full transition"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                
                <div class="bg-white p-6 rounded-b-xl shadow-lg border-b-4 border-blue-900">
                    <div id="dailyCheckLoading" class="flex flex-col items-center justify-center py-12">
                         <i class="fa-solid fa-circle-notch fa-spin text-4xl text-blue-600 mb-3"></i>
                         <p class="text-gray-500">Loading Configuration...</p>
                    </div>

                    <form id="dailyCheckForm" class="hidden space-y-6">
                        <div class="flex justify-end mb-4">
                             <button type="button" onclick="app.dailyCheck.resetForm()" class="text-sm text-red-500 hover:text-red-700 hover:underline flex items-center gap-1">
                                <i class="fa-solid fa-rotate-left"></i> Reset Form
                             </button>
                        </div>
                        
                        <div id="dailyCheckFormContainer"></div>

                        <button type="submit" id="dailyCheckSubmitBtn" class="w-full bg-blue-900 text-white font-bold py-4 rounded-lg shadow hover:bg-blue-800 transition flex justify-center items-center gap-2">
                            <span>Submit Checklist</span>
                            <i class="fa-solid fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>
        </section>

    </main>

    <div id="toast" class="fixed top-4 right-4 z-[100] hidden px-6 py-4 rounded-lg shadow-xl transform transition-all duration-300 translate-y-[-20px] opacity-0 border">
        <div class="flex items-center gap-3">
            <div id="toast-icon" class="text-lg"></div>
            <div id="toast-msg" class="font-medium text-sm"></div>
        </div>
    </div>

    <div id="signature-modal" class="fixed inset-0 bg-black/80 z-[60] hidden flex flex-col items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg flex flex-col overflow-hidden animate-[modal-enter_0.2s_ease-out]">
            <div class="bg-slate-100 p-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                    <i class="fa-solid fa-pen-nib text-blue-600"></i>
                    <span id="sig-modal-title">Sign Here</span>
                </h3>
                <button onclick="app.dailyCheck.closeSignatureModal()" class="text-slate-400 hover:text-slate-600 transition">
                    <i class="fa-solid fa-xmark text-2xl"></i>
                </button>
            </div>
            
            <div class="relative flex-grow bg-white" style="height: 300px; touch-action: none;">
                <canvas id="signature-canvas" class="w-full h-full cursor-crosshair touch-none block"></canvas>
                <div class="absolute bottom-2 left-0 right-0 text-center pointer-events-none opacity-20 text-4xl font-bold text-gray-300 select-none">
                    SIGN HERE
                </div>
            </div>

            <div class="p-4 border-t bg-slate-50 flex gap-3">
                <button onclick="app.dailyCheck.clearSignature()" class="flex-1 py-3 px-4 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-white transition shadow-sm">
                    Clear
                </button>
                <button onclick="app.dailyCheck.saveSignature()" class="flex-[2] py-3 px-4 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition shadow-md flex items-center justify-center gap-2">
                    <i class="fa-solid fa-check"></i> Save Signature
                </button>
            </div>
        </div>
    </div>

    <div id="modal-run" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl p-6 w-full max-w-sm mx-4 shadow-2xl animate-[fadeIn_0.2s_ease-out]">
            <h3 class="text-xl font-bold mb-4 text-center">Enter Run Number</h3>
            <div class="flex justify-center items-center gap-2 mb-6">
                <input type="number" id="run-part-1" class="w-20 h-16 text-center text-2xl border-2 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition" placeholder="##">
                <span class="text-2xl font-bold text-gray-400">-</span>
                <input type="number" id="run-part-2" class="w-28 h-16 text-center text-2xl border-2 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition" placeholder="###">
            </div>
            <div class="flex gap-3">
                <button onclick="document.getElementById('modal-run').classList.add('hidden')" class="flex-1 py-3 border rounded-lg hover:bg-gray-50 font-medium">Cancel</button>
                <button onclick="app.drugBag.confirmRun()" class="flex-1 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-md">Confirm</button>
            </div>
        </div>
    </div>

    <div id="modal-expire" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl p-6 w-full max-w-sm mx-4 shadow-2xl animate-[fadeIn_0.2s_ease-out]">
            <h3 class="text-xl font-bold mb-2 text-center text-red-600">Old Bag Expiration</h3>
            <p class="text-center text-sm text-gray-500 mb-4">Enter expiration date of the REMOVED bag.</p>
            <input type="date" id="modal-expire-input" class="w-full p-4 border-2 rounded-lg mb-6 text-lg">
            <div class="flex gap-3">
                <button onclick="document.getElementById('modal-expire').classList.add('hidden')" class="flex-1 py-3 border rounded-lg hover:bg-gray-50 font-medium">Cancel</button>
                <button onclick="app.drugBag.confirmExpire()" class="flex-1 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold shadow-md">Confirm</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, updateDoc, setDoc, getDoc, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
          apiKey: "AIzaSyBsaM_8RjTsgaSOPrOkyaK1DXghCHumxkc",
          authDomain: "pleasant-fire.firebaseapp.com",
          projectId: "pleasant-fire",
          storageBucket: "pleasant-fire.firebasestorage.app",
          messagingSenderId: "107375626982",
          appId: "1:107375626982:web:97eed5f81377b15eba8927",
          measurementId: "G-TT4G7K37M2"
        };
        
        // This is the current "local" app scope
        const appId = 'pleasant-fire';

        const firebaseApp = initializeApp(firebaseConfig);
        const auth = getAuth(firebaseApp);
        const db = getFirestore(firebaseApp);

        // --- Helper for Consistent Paths (Defaults to 'pleasant-fire') ---
        const getColPath = (colName) => {
            // Path: artifacts/{appId}/public/data/{colName}
            return `artifacts/${appId}/public/data/${colName}`;
        };

        const showToast = (msg, type = 'success') => {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const txt = document.getElementById('toast-msg');

            toast.classList.remove('hidden', 'bg-green-50', 'text-green-800', 'bg-red-50', 'text-red-800', 'border-green-200', 'border-red-200');
            toast.style.opacity = '1';
            toast.style.transform = 'translateY(0)';

            if (type === 'success') {
                toast.classList.add('bg-green-50', 'text-green-800', 'border-green-200');
                icon.innerHTML = '<i class="fa-solid fa-circle-check"></i>';
            } else {
                toast.classList.add('bg-red-50', 'text-red-800', 'border-red-200');
                icon.innerHTML = '<i class="fa-solid fa-circle-exclamation"></i>';
            }

            txt.textContent = msg;
            toast.classList.remove('hidden');

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-20px)';
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        };

        let memberCache = null;
        const loadMembers = async () => {
            if (memberCache) return memberCache;
            try {
                // Fetch from Firestore 'roster' collection in the local app
                const snap = await getDocs(collection(db, getColPath('roster')));
                const members = [];
                snap.forEach(d => {
                    const data = d.data();
                    if(data.lastName && data.firstName) {
                        members.push(`${data.lastName}, ${data.firstName}`);
                    }
                });
                // Sort alphabetically
                members.sort();
                memberCache = members;
                return members;
            } catch(e) {
                console.error("Member fetch error:", e);
                return [];
            }
        };

        const populateMemberSelects = async () => {
            const members = await loadMembers();
            const selects = document.querySelectorAll('.member-select');
            selects.forEach(sel => {
                sel.innerHTML = '<option value="" disabled selected>Select Member...</option>';
                members.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m;
                    opt.textContent = m;
                    sel.appendChild(opt);
                });
            });
        };

        // --- APP MODULES ---

        const App = {
            user: null,

            init: async () => {
                lucide.createIcons();
                
                // Monitor Auth State
                onAuthStateChanged(auth, (user) => {
                    App.user = user;
                    const status = document.getElementById('user-status');
                    const indicator = document.getElementById('status-indicator');
                    if(user) {
                        status.textContent = 'Connected';
                        status.className = 'text-xs font-medium text-green-400';
                        indicator.className = 'w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]';
                        populateMemberSelects(); 
                        App.supply.loadInventory(); 
                        App.drugBag.loadBagStatus();
                        App.dailyCheck.loadConfig();
                    } else {
                        status.textContent = 'Offline';
                        status.className = 'text-xs font-medium text-red-400';
                        indicator.className = 'w-2 h-2 rounded-full bg-red-500';
                    }
                });

                window.addEventListener('offline', () => {
                    const status = document.getElementById('user-status');
                    const indicator = document.getElementById('status-indicator');
                    status.textContent = 'No Internet';
                    status.className = 'text-xs font-medium text-red-400';
                    indicator.className = 'w-2 h-2 rounded-full bg-red-500 animate-pulse';
                });

                window.addEventListener('online', () => {
                     if (!auth.currentUser) signInAnonymously(auth);
                });

                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        throw new Error("No custom token available");
                    }
                } catch (e) { 
                    try {
                        await signInAnonymously(auth);
                    } catch (anonError) {
                        console.error("Anonymous auth failed", anonError);
                        showToast("Authentication Failed. Check internet.", "error");
                    }
                }

                App.navTo('hub');
                App.supply.init();
                App.drugBag.init();
                App.oxygen.init();
                App.destroy.init();
                App.dailyCheck.init();
                App.dailyCheck.initSignatureModal(); // Initialize modal events
            },

            navTo: (viewName) => {
                document.querySelectorAll('.view-section').forEach(el => {
                    el.classList.remove('active');
                    if(el.id === `view-${viewName}`) el.classList.add('active');
                });
                
                const homeBtn = document.getElementById('nav-home-btn');
                if(viewName === 'hub') homeBtn.classList.add('hidden');
                else homeBtn.classList.remove('hidden');

                lucide.createIcons();
            },

            // --- MODULE 1: SUPPLY LOG ---
            supply: {
                inventory: [],
                init: () => {
                    const input = document.getElementById('supplyItemInput');
                    input.addEventListener('input', (e) => {
                        const val = e.target.value;
                        const item = App.supply.inventory.find(i => i.name === val);
                        const det = document.getElementById('supplyItemDetails');
                        const qtyInput = document.getElementById('supplyQtyInput');
                        
                        if(item) {
                            det.textContent = `In Stock: ${item.quantity}`;
                            qtyInput.max = item.quantity;
                        } else {
                            det.textContent = '';
                            qtyInput.removeAttribute('max');
                        }
                    });

                    const container = document.getElementById('supplyReasonContainer');
                    const hidden = document.getElementById('supplyReasonInput');
                    container.addEventListener('click', (e) => {
                        if(e.target.classList.contains('btn-choice')) {
                            container.querySelectorAll('.btn-choice').forEach(b => b.classList.remove('active'));
                            e.target.classList.add('active');
                            hidden.value = e.target.dataset.value;
                        }
                    });

                    document.getElementById('supplyForm').addEventListener('submit', App.supply.submit);
                },
                loadInventory: async () => {
                    if(!App.user) return;
                    const list = document.getElementById('supplyList');
                    list.innerHTML = '';
                    App.supply.inventory = [];
                    
                    try {
                        const snap = await getDocs(collection(db, 'artifacts/pleasant-township-app/public/data/supplies'));
                        snap.forEach(d => {
                            const data = d.data();
                            if(data.quantity > 0) {
                                App.supply.inventory.push({id: d.id, name: data.item, quantity: data.quantity});
                                const opt = document.createElement('option');
                                opt.value = data.item;
                                list.appendChild(opt);
                            }
                        });
                    } catch(e) { console.error("Inv Load Error", e); }
                },
                submit: async (e) => {
                    e.preventDefault();
                    if(!App.user) return showToast("Not authenticated", "error");

                    const btn = document.getElementById('supplySubmitBtn');
                    const originalContent = btn.innerHTML;
                    btn.disabled = true;
                    btn.textContent = "Processing...";

                    try {
                        const fd = new FormData(e.target);
                        const itemVal = fd.get('item');
                        const qty = parseInt(fd.get('quantityTaken'));
                        
                        const stockItem = App.supply.inventory.find(i => i.name === itemVal);
                        
                        if(!stockItem) throw new Error("Invalid Item - select from list");
                        if(qty > stockItem.quantity) throw new Error("Insufficient Stock");

                        await updateDoc(doc(db, 'artifacts/pleasant-township-app/public/data/supplies', stockItem.id), {
                            quantity: stockItem.quantity - qty,
                            lastUpdated: serverTimestamp()
                        });

                        await addDoc(collection(db, getColPath('transactions')), {
                            item: itemVal,
                            quantityTaken: qty,
                            person: fd.get('person'),
                            reason: fd.get('reason'),
                            loggedAt: serverTimestamp()
                        });

                        showToast("Supply logged out!");
                        e.target.reset();
                        document.getElementById('supplyItemDetails').textContent = '';
                        document.querySelectorAll('#supplyReasonContainer .btn-choice').forEach(b => b.classList.remove('active'));
                        App.supply.loadInventory(); 

                    } catch(err) {
                        showToast(err.message, 'error');
                    } finally {
                        btn.disabled = false;
                        btn.innerHTML = originalContent;
                    }
                }
            },

            // --- MODULE 2: DRUG BAG ---
            drugBag: {
                currentBagData: {},
                init: () => {
                    document.getElementById('drugBagForm').addEventListener('submit', App.drugBag.submit);
                    
                    const p1 = document.getElementById('run-part-1');
                    const p2 = document.getElementById('run-part-2');
                    p1.addEventListener('input', () => { if(p1.value.length >= 2) p2.focus(); });
                    p2.addEventListener('keydown', (e) => { if(e.key === 'Backspace' && p2.value === '') p1.focus(); });
                },
                loadBagStatus: async () => {
                    const apparatus = "Medic 75";
                    ['Bag 1', 'Bag 2'].forEach(async (bag) => {
                        const label = document.getElementById(bag === 'Bag 1' ? 'label-bag1' : 'label-bag2');
                        try {
                            const d = await getDoc(doc(db, getColPath('bags'), `${apparatus} - ${bag}`));
                            if(d.exists()) {
                                const val = d.data().bagNumber || 'Empty';
                                label.textContent = val;
                                App.drugBag.currentBagData[bag] = val;
                            } else {
                                label.textContent = 'Empty';
                            }
                        } catch(e) {
                             label.textContent = '--';
                        }
                    });
                },
                selectBag: (bagId) => {
                    document.getElementById('drugBagIdentifier').value = bagId;
                    const btn1 = document.getElementById('btn-bag1');
                    const btn2 = document.getElementById('btn-bag2');
                    
                    if(bagId === 'Bag 1') {
                        btn1.classList.add('bg-blue-50', 'border-blue-500', 'text-blue-700');
                        btn2.classList.remove('bg-blue-50', 'border-blue-500', 'text-blue-700');
                    } else {
                        btn2.classList.add('bg-blue-50', 'border-blue-500', 'text-blue-700');
                        btn1.classList.remove('bg-blue-50', 'border-blue-500', 'text-blue-700');
                    }
                },
                selectReason: (reason) => {
                    document.getElementById('drugReasonInput').value = reason;
                    document.querySelectorAll('.btn-reason').forEach(b => {
                        b.classList.remove('bg-blue-100', 'border-blue-500', 'text-blue-800');
                        if(b.textContent.includes(reason)) b.classList.add('bg-blue-100', 'border-blue-500', 'text-blue-800');
                    });
                    if(reason === 'Used') {
                        document.getElementById('modal-run').classList.remove('hidden');
                        document.getElementById('run-part-1').focus();
                    } else if (reason === 'Expired') {
                        document.getElementById('modal-expire').classList.remove('hidden');
                    }
                },
                confirmRun: () => {
                    const p1 = document.getElementById('run-part-1').value;
                    const p2 = document.getElementById('run-part-2').value;
                    if(!p1 || !p2) return showToast("Incomplete Run #", "error");
                    const runNum = `${p1}-${p2}`;
                    document.getElementById('drugRunNumber').value = runNum;
                    document.getElementById('display-run').textContent = `Run: ${runNum}`;
                    document.getElementById('modal-run').classList.add('hidden');
                },
                confirmExpire: () => {
                    const date = document.getElementById('modal-expire-input').value;
                    if(!date) return showToast("Select Date", "error");
                    document.getElementById('drugOldExpiration').value = date;
                    document.getElementById('display-expired').textContent = `Exp: ${date}`;
                    document.getElementById('modal-expire').classList.add('hidden');
                },
                submit: async (e) => {
                    e.preventDefault();
                    if(!App.user) return showToast("Not auth", "error");

                    const btn = document.getElementById('drugSubmitBtn');
                    const originalContent = btn.innerHTML;
                    btn.disabled = true;
                    btn.textContent = "Submitting...";

                    try {
                        const bagId = document.getElementById('drugBagIdentifier').value;
                        const reason = document.getElementById('drugReasonInput').value;
                        const newBagNum = document.getElementById('drugNewBagNum').value;
                        const expiry = document.getElementById('drugExpiration').value;
                        const facility = document.getElementById('drugFacility').value;
                        const member = document.getElementById('drugMemberSelect').value;
                        
                        const oldBagNum = App.drugBag.currentBagData[bagId] || "Unknown";
                        const apparatus = `Medic 75 - ${bagId}`;

                        let finalReason = reason;
                        if(reason === 'Used') finalReason += ` (Run: ${document.getElementById('drugRunNumber').value})`;
                        if(reason === 'Expired') finalReason += ` (Exp: ${document.getElementById('drugOldExpiration').value})`;

                        const record = {
                            apparatus,
                            oldBagNumber: oldBagNum,
                            newBagNumber: newBagNum,
                            expirationDate: expiry,
                            facility,
                            reason: finalReason,
                            submittedBy: member,
                            timestamp: serverTimestamp()
                        };

                        await addDoc(collection(db, getColPath('exchanges')), record);
                        await setDoc(doc(db, getColPath('bags'), apparatus), {
                            apparatus,
                            bagNumber: newBagNum,
                            expirationDate: expiry,
                            lastUpdated: serverTimestamp()
                        });

                        showToast("Exchange Recorded");
                        e.target.reset();
                        App.drugBag.selectBag('Bag 1'); 
                        document.querySelectorAll('.btn-reason').forEach(b => b.classList.remove('active', 'bg-blue-100'));
                        document.getElementById('display-run').textContent = '';
                        document.getElementById('display-expired').textContent = '';
                        App.drugBag.loadBagStatus(); 

                    } catch(err) {
                        showToast(err.message, "error");
                    } finally {
                        btn.disabled = false;
                        btn.innerHTML = originalContent;
                    }
                }
            },

            // --- MODULE 3: OXYGEN ---
            oxygen: {
                init: () => {
                    document.getElementById('oxygenForm').addEventListener('submit', App.oxygen.submit);
                },
                toggleFields: () => {
                    const type = document.getElementById('oxygenLogType').value;
                    const main = document.getElementById('oxMainFields');
                    const port = document.getElementById('oxPortableFields');
                    
                    if(type === 'Main Tank') {
                        main.classList.remove('hidden');
                        port.classList.add('hidden');
                    } else {
                        main.classList.add('hidden');
                        port.classList.remove('hidden');
                    }
                },
                submit: async (e) => {
                    e.preventDefault();
                    if(!App.user) return showToast("Not Auth", "error");

                    const btn = document.getElementById('oxSubmitBtn');
                    const originalContent = btn.innerHTML;
                    btn.disabled = true;
                    btn.textContent = "Saving...";

                    try {
                        const type = document.getElementById('oxygenLogType').value;
                        const data = {
                            logType: type,
                            member: document.getElementById('oxygenMemberSelect').value,
                            issues: document.getElementById('oxIssues').value,
                            createdAt: serverTimestamp(),
                            dateTime: new Date().toLocaleString()
                        };

                        if(type === 'Main Tank') {
                            data.newLot = document.getElementById('oxNewLot').value;
                            data.oldLot = document.getElementById('oxOldLot').value;
                            data.newPsi = document.getElementById('oxNewPsi').value;
                            data.oldPsi = document.getElementById('oxOldPsi').value;
                        } else {
                            data.portableId = document.getElementById('oxPortableId').value;
                            data.cyl1 = { lot: document.getElementById('oxCyl1Lot').value, psi: document.getElementById('oxCyl1Psi').value };
                            data.cyl2 = { lot: document.getElementById('oxCyl2Lot').value, psi: document.getElementById('oxCyl2Psi').value };
                        }

                        await addDoc(collection(db, getColPath('oxygen_logs')), data);
                        showToast("Oxygen Logged");
                        e.target.reset();
                        App.oxygen.toggleFields();
                    } catch(err) {
                        showToast(err.message, "error");
                    } finally {
                        btn.disabled = false;
                        btn.innerHTML = originalContent;
                    }
                }
            },

            // --- MODULE 4: DESTRUCTION ---
            destroy: {
                init: () => {
                    document.getElementById('destDate').valueAsDate = new Date();
                    document.getElementById('destroyForm').addEventListener('submit', App.destroy.submit);
                },
                submit: async (e) => {
                    e.preventDefault();
                    if(!App.user) return showToast("Not Auth", "error");
                    
                    const btn = document.getElementById('destSubmitBtn');
                    const originalContent = btn.innerHTML;
                    btn.disabled = true;
                    btn.textContent = "Saving...";

                    try {
                        const data = {
                            date: document.getElementById('destDate').value,
                            professional: document.getElementById('destProf').value,
                            drug: {
                                name: document.getElementById('destDrugName').value,
                                strength: document.getElementById('destStrength').value,
                                quantity: document.getElementById('destQty').value,
                                form: document.getElementById('destForm').value
                            },
                            method: document.getElementById('destMethod').value,
                            createdAt: serverTimestamp()
                        };

                        await addDoc(collection(db, getColPath('drug_destruction_logs')), data);
                        showToast("Destruction Recorded");
                        
                        document.getElementById('destDrugName').value = '';
                        document.getElementById('destStrength').value = '';
                        document.getElementById('destQty').value = '';
                        
                    } catch(err) {
                        showToast(err.message, "error");
                    } finally {
                        btn.disabled = false;
                        btn.innerHTML = originalContent;
                        lucide.createIcons();
                    }
                }
            },

            // --- MODULE 5: DAILY CHECK ---
            dailyCheck: {
                _saveTimeout: null,
                activeSigField: null,
                DEFAULT_CONFIG: {
                    sections: [
                        { id: "General", title: "Crew Information", fields: [
                            {label: "Submitted By", name: "SubmittedBy", type: "text", width: "half"},
                            {label: "Date", name: "Date", type: "date", width: "half"},
                            {label: "Crew Member #1", name: "Crew1", type: "text", width: "half"},
                            {label: "Crew Member #2", name: "Crew2", type: "text", width: "half"}
                        ]},
                        { id: "Cab", title: "Cab Checks", fields: [
                            {label: "Mileage", name: "Mileage", type: "number", width: "third"},
                            {label: "Fuel Level", name: "Fuel", type: "select", options: "Full,3/4,1/2,1/4,Empty", width: "third"},
                            {label: "DEF Level", name: "DEF", type: "select", options: "Full,3/4,1/2,1/4,Empty", width: "third"},
                            {label: "Door Opener", name: "DoorOpener", type: "checkbox", width: "quarter"},
                            {label: "Truck Start", name: "TruckStart", type: "checkbox", width: "quarter"},
                            {label: "Fuel Card", name: "FuelCard", type: "checkbox", width: "quarter"},
                            {label: "Safety Vests (x3)", name: "SafetyVests", type: "checkbox", width: "quarter"}
                        ]},
                        { id: "Footer", title: "Comments & Signatures", fields: [
                            {label: "Problems or Concerns", name: "Comments", type: "textarea", width: "full"},
                            {label: "Crew Signature #1", name: "Sig1", type: "signature", width: "half"},
                            {label: "Crew Signature #2", name: "Sig2", type: "signature", width: "half"}
                        ]}
                    ]
                },
                init: () => {
                    const form = document.getElementById('dailyCheckForm');
                    form.addEventListener('submit', App.dailyCheck.submit);
                    
                    form.addEventListener('input', () => App.dailyCheck.saveDraft());
                    form.addEventListener('change', () => App.dailyCheck.saveDraft());
                },
                saveDraft: () => {
                    if (App.dailyCheck._saveTimeout) clearTimeout(App.dailyCheck._saveTimeout);
                    
                    App.dailyCheck._saveTimeout = setTimeout(() => {
                        try {
                            const form = document.getElementById('dailyCheckForm');
                            const inputs = form.querySelectorAll('input, select, textarea');
                            const data = {};
                            
                            inputs.forEach(input => {
                                if (!input.name) return;
                                if (input.type === 'checkbox') {
                                    data[input.name] = input.checked;
                                } else {
                                    data[input.name] = input.value;
                                }
                            });
                            
                            localStorage.setItem('ems_daily_check_draft', JSON.stringify(data));
                        } catch (e) { console.error("Auto-save failed", e); }
                    }, 500);
                },
                restoreDraft: () => {
                    try {
                        const raw = localStorage.getItem('ems_daily_check_draft');
                        if (!raw) return;
                        
                        const data = JSON.parse(raw);
                        const form = document.getElementById('dailyCheckForm');
                        
                        Object.keys(data).forEach(name => {
                            const input = form.querySelector(`[name="${name}"]`);
                            if (input) {
                                // SKIP restoring signatures to prevent "pre-signed" confusion
                                if (input.type === 'hidden' && name.startsWith('Sig')) {
                                    return; 
                                }

                                if (input.type === 'checkbox') {
                                    input.checked = data[name];
                                } else {
                                    input.value = data[name];
                                }
                            }
                        });
                    } catch (e) { console.error("Error restoring draft", e); }
                },
                initSignatureModal: () => {
                    const canvas = document.getElementById('signature-canvas');
                    const ctx = canvas.getContext('2d');
                    let isDrawing = false;
                    let lastX = 0;
                    let lastY = 0;
                    let canvasRect = canvas.getBoundingClientRect();

                    const getCoords = (e) => {
                        let clientX, clientY;
                        if (e.touches && e.touches.length > 0) {
                            clientX = e.touches[0].clientX;
                            clientY = e.touches[0].clientY;
                        } else {
                            clientX = e.clientX;
                            clientY = e.clientY;
                        }
                        return {
                            x: clientX - canvasRect.left,
                            y: clientY - canvasRect.top
                        };
                    };

                    const startDraw = (e) => {
                        isDrawing = true;
                        canvasRect = canvas.getBoundingClientRect(); // Update on start
                        const {x, y} = getCoords(e);
                        lastX = x;
                        lastY = y;
                        ctx.beginPath();
                        ctx.moveTo(x, y);
                        ctx.lineWidth = 3;
                        ctx.lineCap = 'round';
                        ctx.strokeStyle = '#000';
                    };

                    const moveDraw = (e) => {
                        if (!isDrawing) return;
                        e.preventDefault(); // Stop scrolling
                        const {x, y} = getCoords(e);
                        ctx.beginPath();
                        ctx.moveTo(lastX, lastY);
                        ctx.lineTo(x, y);
                        ctx.stroke();
                        lastX = x;
                        lastY = y;
                    };

                    const endDraw = () => {
                        isDrawing = false;
                    };

                    canvas.addEventListener('mousedown', startDraw);
                    canvas.addEventListener('mousemove', moveDraw);
                    canvas.addEventListener('mouseup', endDraw);
                    canvas.addEventListener('mouseleave', endDraw);
                    
                    canvas.addEventListener('touchstart', startDraw, {passive: false});
                    canvas.addEventListener('touchmove', moveDraw, {passive: false});
                    canvas.addEventListener('touchend', endDraw);
                },
                openSignatureModal: (fieldId, label) => {
                    App.dailyCheck.activeSigField = fieldId;
                    document.getElementById('sig-modal-title').textContent = label;
                    const modal = document.getElementById('signature-modal');
                    const canvas = document.getElementById('signature-canvas');
                    
                    modal.classList.remove('hidden');
                    
                    // Slightly delay resize to allow modal to render dimensions
                    setTimeout(() => {
                         const parent = canvas.parentElement;
                         canvas.width = parent.clientWidth;
                         canvas.height = parent.clientHeight;
                         const ctx = canvas.getContext('2d');
                         ctx.clearRect(0, 0, canvas.width, canvas.height); // Clear previous
                    }, 50);
                },
                closeSignatureModal: () => {
                    document.getElementById('signature-modal').classList.add('hidden');
                    App.dailyCheck.activeSigField = null;
                },
                clearSignature: () => {
                    const canvas = document.getElementById('signature-canvas');
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                },
                saveSignature: () => {
                    const fieldId = App.dailyCheck.activeSigField;
                    if(!fieldId) return;

                    const canvas = document.getElementById('signature-canvas');
                    const dataUrl = canvas.toDataURL();

                    // Update Hidden Input
                    document.getElementById(fieldId).value = dataUrl;

                    // Update UI Preview
                    const previewImg = document.getElementById(`preview-img-${fieldId}`);
                    const previewCont = document.getElementById(`preview-container-${fieldId}`);
                    const placeholder = document.getElementById(`placeholder-container-${fieldId}`);

                    previewImg.src = dataUrl;
                    previewCont.classList.remove('hidden');
                    placeholder.classList.add('hidden');

                    App.dailyCheck.saveDraft();
                    App.dailyCheck.closeSignatureModal();
                },
                resetForm: () => {
                    if(confirm("Are you sure you want to clear the form? This cannot be undone.")) {
                        const form = document.getElementById('dailyCheckForm');
                        form.reset();
                        localStorage.removeItem('ems_daily_check_draft');
                        
                        // Reset all signature fields
                        document.querySelectorAll('[id^="preview-container-"]').forEach(el => el.classList.add('hidden'));
                        document.querySelectorAll('[id^="placeholder-container-"]').forEach(el => el.classList.remove('hidden'));
                        document.querySelectorAll('[id^="preview-img-"]').forEach(el => el.src = "");
                        
                        showToast("Form Reset", "success");
                    }
                },
                loadConfig: async () => {
                    const loading = document.getElementById('dailyCheckLoading');
                    const form = document.getElementById('dailyCheckForm');
                    
                    try {
                        const docRef = doc(db, getColPath('medic_75_config/form_structure'));
                        const snap = await getDoc(docRef);
                        
                        let config = App.dailyCheck.DEFAULT_CONFIG;
                        if (snap.exists() && snap.data().sections && snap.data().sections.length > 0) {
                            config = snap.data();
                        }
                        
                        App.dailyCheck.render(config);
                        loading.classList.add('hidden');
                        form.classList.remove('hidden');
                        App.dailyCheck.restoreDraft();

                    } catch(e) {
                        console.warn("Could not load config, using default", e);
                        App.dailyCheck.render(App.dailyCheck.DEFAULT_CONFIG);
                        loading.classList.add('hidden');
                        form.classList.remove('hidden');
                        App.dailyCheck.restoreDraft();
                    }
                },
                render: (config) => {
                    const container = document.getElementById('dailyCheckFormContainer');
                    container.innerHTML = '';

                    config.sections.forEach(section => {
                        const sectionEl = document.createElement('div');
                        sectionEl.className = "bg-gray-50 p-4 rounded-lg border border-gray-200 mb-6";
                        sectionEl.innerHTML = `<h3 class="text-lg font-bold mb-4 border-b pb-2 text-blue-800 uppercase">${section.title}</h3>`;
                        
                        const grid = document.createElement('div');
                        grid.className = "flex flex-wrap -mx-2"; 
                        
                        section.fields.forEach(field => {
                            const fieldId = `${section.id}_${field.name}`;
                            const wrapper = document.createElement('div');
                            
                            let widthClass = "w-full";
                            if(field.width === 'half') widthClass = "w-full md:w-1/2";
                            if(field.width === 'third') widthClass = "w-1/2 md:w-1/3";
                            if(field.width === 'quarter') widthClass = "w-1/2 md:w-1/4";
                            
                            wrapper.className = `px-2 mb-4 ${widthClass}`;

                            if (field.type === 'checkbox') {
                                wrapper.innerHTML = `
                                    <div class="flex items-center h-full pt-4">
                                        <label class="flex items-center space-x-2 cursor-pointer p-3 bg-white border rounded hover:bg-gray-50 w-full hover:border-blue-300 transition">
                                            <input type="checkbox" name="${fieldId}" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500 cursor-pointer">
                                            <span class="text-sm font-medium text-gray-700 select-none">${field.label}</span>
                                        </label>
                                    </div>
                                `;
                            } else if (field.type === 'select') {
                                const opts = field.options ? field.options.split(',') : [];
                                const optsHtml = opts.map(o => `<option>${o.trim()}</option>`).join('');
                                wrapper.innerHTML = `
                                    <label class="block text-sm font-medium mb-1 text-gray-700">${field.label}</label>
                                    <select name="${fieldId}" class="w-full border border-gray-300 rounded p-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white">
                                        ${optsHtml}
                                    </select>
                                `;
                            } else if (field.type === 'textarea') {
                                wrapper.innerHTML = `
                                    <label class="block text-sm font-medium mb-1 text-gray-700">${field.label}</label>
                                    <textarea name="${fieldId}" rows="3" class="w-full border border-gray-300 rounded p-2 focus:ring-2 focus:ring-blue-500"></textarea>
                                `;
                            } else if (field.type === 'signature') {
                                wrapper.innerHTML = `
                                    <label class="block text-sm font-medium mb-1 text-gray-700">${field.label}</label>
                                    <div onclick="app.dailyCheck.openSignatureModal('${fieldId}', '${field.label}')" 
                                         class="border-2 border-dashed border-gray-300 rounded-lg p-6 bg-white cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition flex flex-col items-center justify-center min-h-[120px] shadow-sm">
                                        
                                        <div id="preview-container-${fieldId}" class="hidden w-full flex flex-col items-center">
                                            <img id="preview-img-${fieldId}" class="max-h-16 object-contain mb-2" alt="Signature">
                                            <span class="text-xs font-bold text-green-600 bg-green-100 px-2 py-1 rounded-full">
                                                <i class="fa-solid fa-check"></i> Signed
                                            </span>
                                        </div>

                                        <div id="placeholder-container-${fieldId}" class="text-gray-400 flex flex-col items-center">
                                            <i class="fa-solid fa-pen-nib text-3xl mb-2"></i>
                                            <span class="text-sm font-medium">Tap to Sign</span>
                                        </div>
                                    </div>
                                    <input type="hidden" name="${fieldId}" id="${fieldId}">
                                `;
                            } else {
                                wrapper.innerHTML = `
                                    <label class="block text-sm font-medium mb-1 text-gray-700">${field.label}</label>
                                    <input type="${field.type}" name="${fieldId}" class="w-full border border-gray-300 rounded p-2 focus:ring-2 focus:ring-blue-500">
                                `;
                            }
                            grid.appendChild(wrapper);
                        });
                        sectionEl.appendChild(grid);
                        container.appendChild(sectionEl);
                    });
                },
                submit: async (e) => {
                    e.preventDefault();
                    const btn = document.getElementById('dailyCheckSubmitBtn');
                    const originalContent = btn.innerHTML;
                    btn.disabled = true;
                    btn.textContent = 'Submitting...';

                    try {
                        const form = e.target;
                        const data = {
                            timestamp: serverTimestamp(),
                            submittedAt: new Date().toISOString(),
                            sections: {}
                        };

                        const inputs = form.querySelectorAll('input, select, textarea');
                        
                        inputs.forEach(input => {
                            if (!input.name) return;
                            let value = input.value;
                            if (input.type === 'checkbox') value = input.checked;

                            const parts = input.name.split('_');
                            if (parts.length > 1) {
                                const section = parts[0];
                                const field = parts.slice(1).join('_');
                                if (!data.sections[section]) data.sections[section] = {};
                                data.sections[section][field] = value;
                            } else {
                                data[input.name] = value;
                            }
                        });

                        await addDoc(collection(db, getColPath('medic_75_daily_checks')), data);
                        
                        showToast('Checklist Submitted Successfully!');
                        localStorage.removeItem('ems_daily_check_draft');
                        e.target.reset();
                        
                        // Reset all signature fields
                        document.querySelectorAll('[id^="preview-container-"]').forEach(el => el.classList.add('hidden'));
                        document.querySelectorAll('[id^="placeholder-container-"]').forEach(el => el.classList.remove('hidden'));
                        document.querySelectorAll('[id^="preview-img-"]').forEach(el => el.src = "");
                        
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    } catch (error) {
                        console.error("Error adding document: ", error);
                        showToast(error.message, 'error');
                    } finally {
                        btn.disabled = false;
                        btn.innerHTML = originalContent;
                    }
                }
            }
        };

        window.app = App;
        App.init();

    </script>
</body>
</html>